from fastapi import FastAPI
from pydantic import BaseModel
import numpy as np
import joblib
from contextlib import asynccontextmanager
from scipy.signal import savgol_filter
import pickle

model_path = "./model/XGBoost_ramman_model_2.h5"
scale_path = "./model/scale_raman_2.h5"

class InputData(BaseModel):
    data: list[list[float]]

class PredictionResponse(BaseModel):
    Predict_Pen: float

ml_models = {}
@asynccontextmanager
async def lifespan(app: FastAPI):
    ml_models["predict"] = pickle.load(open(model_path,'rb'))
    ml_models["scale"] = joblib.load(scale_path)
    yield
    ml_models.clear()

app = FastAPI(lifespan=lifespan)

@app.post("/predict", response_model=list[PredictionResponse])
async def predict(input_data: InputData):
    data = np.array(input_data.data)
    
    start_wavelength = 1100 #start wavelength
    end_wavelength = 1350 #end wavelength
    Intensity = data.T[start_wavelength:end_wavelength]
    X1 = savgol_filter(Intensity.T, 17, polyorder = 3,deriv=2)
    
    # Scaling the data
    data_trans = ml_models["scale"].transform(X1)
    
    # Making predictions
    y_hat = ml_models["predict"].predict(data_trans)
    
    # Form the output in the specified format
    result = []
    for i in range(len(y_hat)):
        row = {
            "Predict_Pen": float(y_hat[i])
        }
        result.append(row)

    return result



# '1300': float(input_data.data[i][1100]),
#             '1299': float(input_data.data[i][1101]),
#             '1298': float(input_data.data[i][1102]),
#             '1297': float(input_data.data[i][1103]),
#             '1296': float(input_data.data[i][1104]),
#             '1295': float(input_data.data[i][1105]),
#             '1294': float(input_data.data[i][1106]),
#             '1293': float(input_data.data[i][1107]),
#             '1292': float(input_data.data[i][1108]),
#             '1291': float(input_data.data[i][1109]),
#             '1290': float(input_data.data[i][1110]),
#             '1289': float(input_data.data[i][1111]),
#             '1288': float(input_data.data[i][1112]),
#             '1287': float(input_data.data[i][1113]),
#             '1286': float(input_data.data[i][1114]),
#             '1285': float(input_data.data[i][1115]),
#             '1284': float(input_data.data[i][1116]),
#             '1283': float(input_data.data[i][1117]),
#             '1282': float(input_data.data[i][1118]),
#             '1281': float(input_data.data[i][1119]),
#             '1280': float(input_data.data[i][1120]),
#             '1279': float(input_data.data[i][1121]),
#             '1278': float(input_data.data[i][1122]),
#             '1277': float(input_data.data[i][1123]),
#             '1276': float(input_data.data[i][1124]),
#             '1275': float(input_data.data[i][1125]),
#             '1274': float(input_data.data[i][1126]),
#             '1273': float(input_data.data[i][1127]),
#             '1272': float(input_data.data[i][1128]),
#             '1271': float(input_data.data[i][1129]),
#             '1270': float(input_data.data[i][1130]),
#             '1269': float(input_data.data[i][1131]),
#             '1268': float(input_data.data[i][1132]),
#             '1267': float(input_data.data[i][1133]),
#             '1266': float(input_data.data[i][1134]),
#             '1265': float(input_data.data[i][1135]),
#             '1264': float(input_data.data[i][1136]),
#             '1263': float(input_data.data[i][1137]),
#             '1262': float(input_data.data[i][1138]),
#             '1261': float(input_data.data[i][1139]),
#             '1260': float(input_data.data[i][1140]),
#             '1259': float(input_data.data[i][1141]),
#             '1258': float(input_data.data[i][1142]),
#             '1257': float(input_data.data[i][1143]),
#             '1256': float(input_data.data[i][1144]),
#             '1255': float(input_data.data[i][1145]),
#             '1254': float(input_data.data[i][1146]),
#             '1253': float(input_data.data[i][1147]),
#             '1252': float(input_data.data[i][1148]),
#             '1251': float(input_data.data[i][1149]),
#             '1250': float(input_data.data[i][1150]),
#             '1249': float(input_data.data[i][1151]),
#             '1248': float(input_data.data[i][1152]),
#             '1247': float(input_data.data[i][1153]),
#             '1246': float(input_data.data[i][1154]),
#             '1245': float(input_data.data[i][1155]),
#             '1244': float(input_data.data[i][1156]),
#             '1243': float(input_data.data[i][1157]),
#             '1242': float(input_data.data[i][1158]),
#             '1241': float(input_data.data[i][1159]),
#             '1240': float(input_data.data[i][1160]),
#             '1239': float(input_data.data[i][1161]),
#             '1238': float(input_data.data[i][1162]),
#             '1237': float(input_data.data[i][1163]),
#             '1236': float(input_data.data[i][1164]),
#             '1235': float(input_data.data[i][1165]),
#             '1234': float(input_data.data[i][1166]),
#             '1233': float(input_data.data[i][1167]),
#             '1232': float(input_data.data[i][1168]),
#             '1231': float(input_data.data[i][1169]),
#             '1230': float(input_data.data[i][1170]),
#             '1229': float(input_data.data[i][1171]),
#             '1228': float(input_data.data[i][1172]),
#             '1227': float(input_data.data[i][1173]),
#             '1226': float(input_data.data[i][1174]),
#             '1225': float(input_data.data[i][1175]),
#             '1224': float(input_data.data[i][1176]),
#             '1223': float(input_data.data[i][1177]),
#             '1222': float(input_data.data[i][1178]),
#             '1221': float(input_data.data[i][1179]),
#             '1220': float(input_data.data[i][1180]),
#             '1219': float(input_data.data[i][1181]),
#             '1218': float(input_data.data[i][1182]),
#             '1217': float(input_data.data[i][1183]),
#             '1216': float(input_data.data[i][1184]),
#             '1215': float(input_data.data[i][1185]),
#             '1214': float(input_data.data[i][1186]),
#             '1213': float(input_data.data[i][1187]),
#             '1212': float(input_data.data[i][1188]),
#             '1211': float(input_data.data[i][1189]),
#             '1210': float(input_data.data[i][1190]),
#             '1209': float(input_data.data[i][1191]),
#             '1208': float(input_data.data[i][1192]),
#             '1207': float(input_data.data[i][1193]),
#             '1206': float(input_data.data[i][1194]),
#             '1205': float(input_data.data[i][1195]),
#             '1204': float(input_data.data[i][1196]),
#             '1203': float(input_data.data[i][1197]),
#             '1202': float(input_data.data[i][1198]),
#             '1201': float(input_data.data[i][1199]),
#             '1200': float(input_data.data[i][1200]),
#             '1199': float(input_data.data[i][1201]),
#             '1198': float(input_data.data[i][1202]),
#             '1197': float(input_data.data[i][1203]),
#             '1196': float(input_data.data[i][1204]),
#             '1195': float(input_data.data[i][1205]),
#             '1194': float(input_data.data[i][1206]),
#             '1193': float(input_data.data[i][1207]),
#             '1192': float(input_data.data[i][1208]),
#             '1191': float(input_data.data[i][1209]),
#             '1190': float(input_data.data[i][1210]),
#             '1189': float(input_data.data[i][1211]),
#             '1188': float(input_data.data[i][1212]),
#             '1187': float(input_data.data[i][1213]),
#             '1186': float(input_data.data[i][1214]),
#             '1185': float(input_data.data[i][1215]),
#             '1184': float(input_data.data[i][1216]),
#             '1183': float(input_data.data[i][1217]),
#             '1182': float(input_data.data[i][1218]),
#             '1181': float(input_data.data[i][1219]),
#             '1180': float(input_data.data[i][1220]),
#             '1179': float(input_data.data[i][1221]),
#             '1178': float(input_data.data[i][1222]),
#             '1177': float(input_data.data[i][1223]),
#             '1176': float(input_data.data[i][1224]),
#             '1175': float(input_data.data[i][1225]),
#             '1174': float(input_data.data[i][1226]),
#             '1173': float(input_data.data[i][1227]),
#             '1172': float(input_data.data[i][1228]),
#             '1171': float(input_data.data[i][1229]),
#             '1170': float(input_data.data[i][1230]),
#             '1169': float(input_data.data[i][1231]),
#             '1168': float(input_data.data[i][1232]),
#             '1167': float(input_data.data[i][1233]),
#             '1166': float(input_data.data[i][1234]),
#             '1165': float(input_data.data[i][1235]),
#             '1164': float(input_data.data[i][1236]),
#             '1163': float(input_data.data[i][1237]),
#             '1162': float(input_data.data[i][1238]),
#             '1161': float(input_data.data[i][1239]),
#             '1160': float(input_data.data[i][1240]),
#             '1159': float(input_data.data[i][1241]),
#             '1158': float(input_data.data[i][1242]),
#             '1157': float(input_data.data[i][1243]),
#             '1156': float(input_data.data[i][1244]),
#             '1155': float(input_data.data[i][1245]),
#             '1154': float(input_data.data[i][1246]),
#             '1153': float(input_data.data[i][1247]),
#             '1152': float(input_data.data[i][1248]),
#             '1151': float(input_data.data[i][1249]),
#             '1150': float(input_data.data[i][1250]),
#             '1149': float(input_data.data[i][1251]),
#             '1148': float(input_data.data[i][1252]),
#             '1147': float(input_data.data[i][1253]),
#             '1146': float(input_data.data[i][1254]),
#             '1145': float(input_data.data[i][1255]),
#             '1144': float(input_data.data[i][1256]),
#             '1143': float(input_data.data[i][1257]),
#             '1142': float(input_data.data[i][1258]),
#             '1141': float(input_data.data[i][1259]),
#             '1140': float(input_data.data[i][1260]),
#             '1139': float(input_data.data[i][1261]),
#             '1138': float(input_data.data[i][1262]),
#             '1137': float(input_data.data[i][1263]),
#             '1136': float(input_data.data[i][1264]),
#             '1135': float(input_data.data[i][1265]),
#             '1134': float(input_data.data[i][1266]),
#             '1133': float(input_data.data[i][1267]),
#             '1132': float(input_data.data[i][1268]),
#             '1131': float(input_data.data[i][1269]),
#             '1130': float(input_data.data[i][1270]),
#             '1129': float(input_data.data[i][1271]),
#             '1128': float(input_data.data[i][1272]),
#             '1127': float(input_data.data[i][1273]),
#             '1126': float(input_data.data[i][1274]),
#             '1125': float(input_data.data[i][1275]),
#             '1124': float(input_data.data[i][1276]),
#             '1123': float(input_data.data[i][1277]),
#             '1122': float(input_data.data[i][1278]),
#             '1121': float(input_data.data[i][1279]),
#             '1120': float(input_data.data[i][1280]),
#             '1119': float(input_data.data[i][1281]),
#             '1118': float(input_data.data[i][1282]),
#             '1117': float(input_data.data[i][1283]),
#             '1116': float(input_data.data[i][1284]),
#             '1115': float(input_data.data[i][1285]),
#             '1114': float(input_data.data[i][1286]),
#             '1113': float(input_data.data[i][1287]),
#             '1112': float(input_data.data[i][1288]),
#             '1111': float(input_data.data[i][1289]),
#             '1110': float(input_data.data[i][1290]),
#             '1109': float(input_data.data[i][1291]),
#             '1108': float(input_data.data[i][1292]),
#             '1107': float(input_data.data[i][1293]),
#             '1106': float(input_data.data[i][1294]),
#             '1105': float(input_data.data[i][1295]),
#             '1104': float(input_data.data[i][1296]),
#             '1103': float(input_data.data[i][1297]),
#             '1102': float(input_data.data[i][1298]),
#             '1101': float(input_data.data[i][1299]),
#             '1100': float(input_data.data[i][1300]),
#             '1099': float(input_data.data[i][1301]),
#             '1098': float(input_data.data[i][1302]),
#             '1097': float(input_data.data[i][1303]),
#             '1096': float(input_data.data[i][1304]),
#             '1095': float(input_data.data[i][1305]),
#             '1094': float(input_data.data[i][1306]),
#             '1093': float(input_data.data[i][1307]),
#             '1092': float(input_data.data[i][1308]),
#             '1091': float(input_data.data[i][1309]),
#             '1090': float(input_data.data[i][1310]),
#             '1089': float(input_data.data[i][1311]),
#             '1088': float(input_data.data[i][1312]),
#             '1087': float(input_data.data[i][1313]),
#             '1086': float(input_data.data[i][1314]),
#             '1085': float(input_data.data[i][1315]),
#             '1084': float(input_data.data[i][1316]),
#             '1083': float(input_data.data[i][1317]),
#             '1082': float(input_data.data[i][1318]),
#             '1081': float(input_data.data[i][1319]),
#             '1080': float(input_data.data[i][1320]),
#             '1079': float(input_data.data[i][1321]),
#             '1078': float(input_data.data[i][1322]),
#             '1077': float(input_data.data[i][1323]),
#             '1076': float(input_data.data[i][1324]),
#             '1075': float(input_data.data[i][1325]),
#             '1074': float(input_data.data[i][1326]),
#             '1073': float(input_data.data[i][1327]),
#             '1072': float(input_data.data[i][1328]),
#             '1071': float(input_data.data[i][1329]),
#             '1070': float(input_data.data[i][1330]),
#             '1069': float(input_data.data[i][1331]),
#             '1068': float(input_data.data[i][1332]),
#             '1067': float(input_data.data[i][1333]),
#             '1066': float(input_data.data[i][1334]),
#             '1065': float(input_data.data[i][1335]),
#             '1064': float(input_data.data[i][1336]),
#             '1063': float(input_data.data[i][1337]),
#             '1062': float(input_data.data[i][1338]),
#             '1061': float(input_data.data[i][1339]),
#             '1060': float(input_data.data[i][1340]),
#             '1059': float(input_data.data[i][1341]),
#             '1058': float(input_data.data[i][1342]),
#             '1057': float(input_data.data[i][1343]),
#             '1056': float(input_data.data[i][1344]),
#             '1055': float(input_data.data[i][1345]),
#             '1054': float(input_data.data[i][1346]),
#             '1053': float(input_data.data[i][1347]),
#             '1052': float(input_data.data[i][1348]),
#             '1051': float(input_data.data[i][1349]),